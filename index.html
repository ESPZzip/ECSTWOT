<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Roblox Revival - Todo en Uno</title>
<style>
  body { margin:0; overflow:hidden; }
  canvas { display:block; }
  #inventory { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.5); padding:10px; border-radius:5px; }
  #inventory button { margin:5px; padding:5px; }
  .playerName { position:absolute; color:white; font-weight:bold; text-shadow:0 0 5px black; pointer-events:none; }
  #toolbar { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.5); padding:5px; border-radius:5px; }
  #toolbar button { margin:2px; padding:5px; }
</style>
</head>
<body>

<div id="inventory">
  <button onclick="selectAvatar('avatar1')">Avatar 1</button>
  <button onclick="selectAvatar('avatar2')">Avatar 2</button>
</div>

<div id="toolbar">
  <button onclick="selectBlockColor(0x888888)">Gris</button>
  <button onclick="selectBlockColor(0xff0000)">Rojo</button>
  <button onclick="selectBlockColor(0x00ff00)">Verde</button>
  <button onclick="selectBlockColor(0x0000ff)">Azul</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
<script>
/* ==== CONFIGURACION === */
const ws = new WebSocket('ws://localhost:8080'); // Cambia a tu IP para LAN
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* ==== VARIABLES === */
let players = {}, blocks = {}, playerLabels = {};
let myId, selectedAvatar='avatar1', selectedColor=0x888888;
const geometry = new THREE.BoxGeometry(1,1,1);
camera.position.z = 5;

/* ==== FUNCIONES === */
function getPlayerMaterial(avatar){
    const color = avatar==='avatar1'?0xffff00:0xff00ff; // Simula textura
    return new THREE.MeshBasicMaterial({color});
}

function createOrUpdatePlayer(id, pdata){
    if(!players[id]){
        let mesh = new THREE.Mesh(geometry,getPlayerMaterial(pdata.avatar));
        mesh.position.set(pdata.x,pdata.y,pdata.z);
        scene.add(mesh);
        players[id] = mesh;

        let label = document.createElement('div');
        label.className='playerName';
        label.innerText = id;
        document.body.appendChild(label);
        playerLabels[id] = label;
    } else {
        players[id].position.set(pdata.x,pdata.y,pdata.z);
        players[id].material = getPlayerMaterial(pdata.avatar);
    }
}

function createOrUpdateBlock(b){
    if(!blocks[b.id]){
        let mat = new THREE.MeshBasicMaterial({color:b.color||0x888888});
        let mesh = new THREE.Mesh(geometry, mat);
        mesh.position.set(b.x,b.y,b.z);
        scene.add(mesh);
        blocks[b.id] = mesh;
    }
}

function animate(){
    requestAnimationFrame(animate);
    renderer.render(scene,camera);
    for(let id in players){
        let vector = players[id].position.clone();
        vector.project(camera);
        let x = (vector.x+1)/2*window.innerWidth;
        let y = (-vector.y+1)/2*window.innerHeight;
        playerLabels[id].style.left = x+'px';
        playerLabels[id].style.top = y+'px';
    }
}
animate();

/* ==== SOCKET === */
ws.onmessage = e=>{
    const data = JSON.parse(e.data);
    if(data.type==='init'){
        myId = data.id;
        for(let id in data.players) createOrUpdatePlayer(id, data.players[id]);
        data.blocks.forEach(b=>createOrUpdateBlock(b));
    }
    if(data.type==='update'){
        for(let id in data.players) createOrUpdatePlayer(id, data.players[id]);
        data.blocks.forEach(b=>createOrUpdateBlock(b));
    }
};

/* ==== CONTROLES === */
document.addEventListener('keydown', e=>{
    let mesh=players[myId]; if(!mesh) return;
    if(e.key==='w') mesh.position.z-=0.2;
    if(e.key==='s') mesh.position.z+=0.2;
    if(e.key==='a') mesh.position.x-=0.2;
    if(e.key==='d') mesh.position.x+=0.2;
    ws.send(JSON.stringify({type:'move', position:{x:mesh.position.x,y:mesh.position.y,z:mesh.position.z}}));
});

document.addEventListener('click', e=>{
    let mesh=players[myId]; if(!mesh) return;
    let id = Date.now().toString();
    let block = {id,x:mesh.position.x,y:mesh.position.y-1,z:mesh.position.z,color:selectedColor};
    ws.send(JSON.stringify({type:'placeBlock', block}));
});

document.addEventListener('contextmenu', e=>{
    e.preventDefault();
    let keys = Object.keys(blocks); if(keys.length===0) return;
    ws.send(JSON.stringify({type:'removeBlock', blockId:keys[keys.length-1]}));
});

/* ==== INVENTARIO / BARRA === */
function selectAvatar(name){ selectedAvatar=name; ws.send(JSON.stringify({type:'changeAvatar', avatar:name})); }
function selectBlockColor(color){ selectedColor=color; }
</script>

</body>
</html>
